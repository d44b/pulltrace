---
phase: 03-release-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/docs.yml
autonomous: true
requirements:
  - HELM-01
  - HELM-02
  - HELM-03
  - HELM-04
  - REL-01

must_haves:
  truths:
    - "`helm repo add pulltrace https://d44b.github.io/pulltrace/charts` succeeds after a semver tag is pushed"
    - "`https://d44b.github.io/pulltrace/charts/index.yaml` is publicly reachable and contains a valid chart entry for v0.1.0"
    - "The docs site at gh-pages root is intact after the helm-pages job completes (keep_files: true preserves it)"
    - "CI does not fail with '403 Resource not accessible' when pushing to gh-pages or creating a GitHub Release"
    - "Concurrent gh-pages pushes from docs.yml and ci.yml are serialized, not rejected as non-fast-forward"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow with contents:write, helm-pages steps in helm-release job, artifact upload, and deploy-gh-pages concurrency group"
      contains: "contents: write"
    - path: ".github/workflows/docs.yml"
      provides: "Docs deploy workflow updated to share deploy-gh-pages concurrency group"
      contains: "deploy-gh-pages"
  key_links:
    - from: ".github/workflows/ci.yml helm-release job"
      to: "gh-pages branch /charts/ path"
      via: "peaceiris/actions-gh-pages@v4 with destination_dir: charts and keep_files: true"
      pattern: "destination_dir: charts"
    - from: ".github/workflows/ci.yml helm-release job"
      to: "/tmp/helm-pages/index.yaml"
      via: "helm repo index /tmp/helm-pages --url https://d44b.github.io/pulltrace/charts"
      pattern: "helm repo index"
    - from: ".github/workflows/ci.yml"
      to: ".github/workflows/docs.yml"
      via: "shared concurrency group name deploy-gh-pages"
      pattern: "group: deploy-gh-pages"
---

<objective>
Fix the `contents: read` permission blocking GitHub Release creation and gh-pages push, extend the existing `helm-release` job with classic Helm repo indexing and gh-pages deployment, and add a shared concurrency group to both `ci.yml` and `docs.yml` to prevent race conditions.

Purpose: This is the prerequisite for the entire release pipeline. Without `contents: write` the release job cannot push to gh-pages or create a GitHub Release. Without the helm-pages steps there is no `index.yaml` at `https://d44b.github.io/pulltrace/charts/index.yaml` and `helm repo add` fails.

Output: Updated `ci.yml` (permissions fixed, helm-pages steps added, chart artifact uploaded, concurrency group added) and updated `docs.yml` (shared concurrency group). After a semver tag push, the classic Helm repo is populated at `https://d44b.github.io/pulltrace/charts/` and the docs site at root is unaffected.
</objective>

<execution_context>
@/Users/jmaciejewski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jmaciejewski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-release-automation/03-RESEARCH.md
@.github/workflows/ci.yml
@.github/workflows/docs.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ci.yml permissions and add deploy-gh-pages concurrency group to both workflows</name>
  <files>.github/workflows/ci.yml, .github/workflows/docs.yml</files>
  <action>
Make two targeted changes:

**1. In `.github/workflows/ci.yml`:**

Change the workflow-level `permissions` block from:
```yaml
permissions:
  contents: read
  packages: write
```
to:
```yaml
permissions:
  contents: write   # required by softprops/action-gh-release and peaceiris/actions-gh-pages push
  packages: write
```

Note: This must be the workflow-level block (top of file, not job-level). Job-level permissions cannot escalate beyond workflow level.

Also change the existing top-level `concurrency` block from:
```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```
to:
```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```
Leave the top-level concurrency block unchanged — it is used by lint/test/docker jobs. The `deploy-gh-pages` concurrency will be added at the job level on `helm-release` in Task 2.

**2. In `.github/workflows/docs.yml`:**

Add a concurrency block to the `deploy` job (NOT at workflow level, because there is no existing workflow-level concurrency):

Before the `steps:` key in the `deploy` job, add:
```yaml
    concurrency:
      group: deploy-gh-pages
      cancel-in-progress: false   # never abort an in-flight gh-pages deployment
```

The result should be:
```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-gh-pages
      cancel-in-progress: false
    steps:
      ...
```

Do NOT change the `keep_files: true` or `destination_dir: "."` in the docs.yml peaceiris step — those are critical for preserving the /charts/ subdir on gh-pages (per Phase 2 pattern decision).
  </action>
  <verify>
    <automated>cd /Users/jmaciejewski/workspace/pulltrace && grep -n "contents: write" .github/workflows/ci.yml && grep -n "deploy-gh-pages" .github/workflows/docs.yml</automated>
    <manual>Confirm ci.yml shows `contents: write` at workflow level (line ~11). Confirm docs.yml deploy job has `concurrency: group: deploy-gh-pages`.</manual>
  </verify>
  <done>
    - `ci.yml` has `contents: write` at workflow level (not `contents: read`)
    - `docs.yml` deploy job has `concurrency: group: deploy-gh-pages` with `cancel-in-progress: false`
  </done>
</task>

<task type="auto">
  <name>Task 2: Add helm-pages steps to helm-release job (helm repo index + gh-pages deploy + artifact upload)</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Extend the existing `helm-release` job in `ci.yml` by appending steps after the "Push chart to GHCR OCI" step. Do NOT remove or modify the existing steps — only append.

The existing job ends with:
```yaml
      - name: Push chart to GHCR OCI
        run: |
          helm push /tmp/charts/pulltrace-${{ steps.version.outputs.version }}.tgz \
            oci://ghcr.io/${{ github.repository_owner }}/charts
```

After that step, add the following in order:

**Step A — Upload artifact (for github-release job to consume without re-packaging):**
```yaml
      - name: Upload chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: /tmp/charts/pulltrace-${{ steps.version.outputs.version }}.tgz
          retention-days: 1
```

**Step B — Stage files for Helm repo index:**
```yaml
      - name: Stage Helm repo files
        run: |
          mkdir -p /tmp/helm-pages
          cp /tmp/charts/pulltrace-${{ steps.version.outputs.version }}.tgz /tmp/helm-pages/
```

**Step C — Generate Helm repo index:**
```yaml
      - name: Generate Helm repo index
        run: |
          helm repo index /tmp/helm-pages \
            --url https://d44b.github.io/pulltrace/charts
```

Note: No `--merge` flag for v0.1.0 (no prior index exists). When publishing v0.2.0+, add sparse-checkout + `--merge` to preserve prior chart versions. The `--url` value MUST exactly match the `helm repo add` URL used by users — any mismatch causes 404 on `helm install`.

**Step D — Deploy charts/ to gh-pages:**
```yaml
      - name: Deploy charts to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: /tmp/helm-pages
          publish_branch: gh-pages
          destination_dir: charts
          keep_files: true
          commit_message: "chore: Helm chart ${{ github.ref_name }}"
```

Also add a job-level `concurrency` block to the `helm-release` job itself (to serialize with docs.yml pushes):
```yaml
  helm-release:
    name: Helm Chart Release
    needs: [docker]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    concurrency:
      group: deploy-gh-pages
      cancel-in-progress: false
    steps:
```

The `destination_dir: charts` and `keep_files: true` combination is critical: it deploys ONLY to the `/charts/` subdirectory of gh-pages, leaving the MkDocs docs site at the root untouched.
  </action>
  <verify>
    <automated>cd /Users/jmaciejewski/workspace/pulltrace && grep -n "helm repo index\|destination_dir: charts\|keep_files\|upload-artifact\|deploy-gh-pages" .github/workflows/ci.yml</automated>
    <manual>Confirm in ci.yml: helm-release job has `concurrency: group: deploy-gh-pages`, four new steps are present after OCI push step, `destination_dir: charts` is set, `keep_files: true` is set, `--url https://d44b.github.io/pulltrace/charts` is correct.</manual>
  </verify>
  <done>
    - `helm-release` job has `concurrency: group: deploy-gh-pages` with `cancel-in-progress: false`
    - `helm repo index /tmp/helm-pages --url https://d44b.github.io/pulltrace/charts` step present
    - `peaceiris/actions-gh-pages@v4` step present with `destination_dir: charts` and `keep_files: true`
    - `actions/upload-artifact@v4` step present, uploading `helm-chart` artifact
    - Existing OCI push step is unchanged
  </done>
</task>

</tasks>

<verification>
Run these checks after both tasks complete:

```bash
# 1. Confirm contents: write at workflow level
grep -A2 "^permissions:" .github/workflows/ci.yml

# 2. Confirm helm-pages steps exist
grep -n "helm repo index\|destination_dir: charts\|keep_files\|upload-artifact" .github/workflows/ci.yml

# 3. Confirm shared concurrency group in both files
grep -n "deploy-gh-pages" .github/workflows/ci.yml .github/workflows/docs.yml

# 4. Confirm ci.yml is valid YAML
python3 -c "import yaml, sys; yaml.safe_load(open('.github/workflows/ci.yml')); print('ci.yml: valid YAML')"
python3 -c "import yaml, sys; yaml.safe_load(open('.github/workflows/docs.yml')); print('docs.yml: valid YAML')"
```
</verification>

<success_criteria>
- `ci.yml` `permissions.contents` is `write` (not `read`)
- `helm-release` job has 4 new steps after OCI push: upload-artifact, stage files, helm repo index, peaceiris deploy
- `helm repo index` uses `--url https://d44b.github.io/pulltrace/charts` (exact match for `helm repo add` URL)
- `peaceiris/actions-gh-pages@v4` configured with `destination_dir: charts` and `keep_files: true`
- `helm-release` job has `concurrency: group: deploy-gh-pages, cancel-in-progress: false`
- `docs.yml` deploy job has `concurrency: group: deploy-gh-pages, cancel-in-progress: false`
- Both workflow files are valid YAML (no parse errors)
</success_criteria>

<output>
After completion, create `.planning/phases/03-release-automation/03-01-SUMMARY.md` summarizing:
- What was changed in ci.yml (permissions line, concurrency block, 4 new steps added to helm-release)
- What was changed in docs.yml (concurrency block added to deploy job)
- The exact --url value used in helm repo index (for Phase 4 verification)
- Any deviation from the plan and why
</output>
