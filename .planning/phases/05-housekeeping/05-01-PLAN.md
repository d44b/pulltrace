---
phase: 05-housekeeping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - CONTRIBUTING.md
  - .planning/REQUIREMENTS.md
autonomous: true
requirements: [MAINT-01, MAINT-02, COMM-01]

must_haves:
  truths:
    - "helm repo index uses --merge so v0.2.0 chart release preserves the v0.1.0 entry in index.yaml"
    - "CONTRIBUTING.md dead link to CODE_OF_CONDUCT.md is absent (already removed; confirmed and requirements updated)"
    - "CONTRIBUTING.md documents the manual social preview image upload step so it is not forgotten in future releases"
    - "REQUIREMENTS.md shows MAINT-01, MAINT-02, COMM-01 as complete after this plan"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Helm repo index step with --merge flag and prior index.yaml fetch"
      contains: "--merge /tmp/helm-pages/index.yaml"
    - path: "CONTRIBUTING.md"
      provides: "Social preview image upload instructions in release checklist section"
      contains: "social preview"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Updated requirement status"
      contains: "[x] **MAINT-01**"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "https://d44b.github.io/pulltrace/charts/index.yaml"
      via: "curl fetch before helm repo index --merge"
      pattern: "curl.*index\\.yaml"
---

<objective>
Clear all three Phase 5 housekeeping requirements: fix the CI helm repo index step to use --merge (MAINT-02), confirm MAINT-01 is already satisfied, document the social preview image upload step for future releases (COMM-01), and update REQUIREMENTS.md to reflect completion.

Purpose: Post-launch debt is cleared so the repo is clean for future contributors and releases.
Output: Updated ci.yml, CONTRIBUTING.md with social preview docs, REQUIREMENTS.md with all three requirements marked done.
</objective>

<execution_context>
@/Users/jmaciejewski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jmaciejewski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CI helm repo index to use --merge flag</name>
  <files>.github/workflows/ci.yml</files>
  <action>
In the `helm-release` job, replace the "Stage Helm repo files" and "Generate Helm repo index" steps with an updated sequence that:

1. Keeps the existing "Stage Helm repo files" step unchanged (mkdir + cp the packaged .tgz).

2. Add a new step BEFORE "Generate Helm repo index" named "Fetch existing Helm repo index":
   ```yaml
   - name: Fetch existing Helm repo index
     run: |
       curl -fsSL https://d44b.github.io/pulltrace/charts/index.yaml \
         -o /tmp/helm-pages/index.yaml \
         || true
   ```
   The `|| true` is critical: on the very first release there will be no existing index.yaml, and the fetch should not fail the job.

3. Update the "Generate Helm repo index" step to add `--merge /tmp/helm-pages/index.yaml`:
   ```yaml
   - name: Generate Helm repo index
     run: |
       helm repo index /tmp/helm-pages \
         --url https://d44b.github.io/pulltrace/charts \
         --merge /tmp/helm-pages/index.yaml
   ```
   When `index.yaml` does not exist (curl failed, `|| true` skipped creation), `helm repo index --merge` with a non-existent file path gracefully generates a fresh index — this is tested helm behavior.

The step ordering in the job must be:
  1. checkout, setup-helm, extract version, update chart versions, package chart
  2. Login to GHCR OCI, Push chart to GHCR OCI, Upload chart artifact
  3. Stage Helm repo files (unchanged)
  4. **Fetch existing Helm repo index** (NEW)
  5. Generate Helm repo index (with --merge added)
  6. Deploy charts to gh-pages (unchanged)

Do not modify any other steps in the workflow.
  </action>
  <verify>
    <automated>grep -A3 "Generate Helm repo index" /Users/jmaciejewski/workspace/pulltrace/.github/workflows/ci.yml | grep -q "\-\-merge" && echo "PASS: --merge flag present" || echo "FAIL: --merge flag missing"</automated>
    <manual>Confirm the Fetch step appears immediately before Generate, uses curl with || true, and the --merge path matches the curl output path (/tmp/helm-pages/index.yaml)</manual>
  </verify>
  <done>ci.yml "Generate Helm repo index" step includes --merge /tmp/helm-pages/index.yaml; a "Fetch existing Helm repo index" step with || true guard precedes it</done>
</task>

<task type="auto">
  <name>Task 2: Document social preview step and close all requirements</name>
  <files>CONTRIBUTING.md, .planning/REQUIREMENTS.md</files>
  <action>
**CONTRIBUTING.md:**

Verify MAINT-01 is satisfied: `git log --oneline -- CONTRIBUTING.md` will show commit `ebdaa3d` "fix(docs): remove dead Code of Conduct link" — confirming the dead link was removed in Phase 1. No change needed for MAINT-01.

Add a "## Release Checklist" section at the end of CONTRIBUTING.md (after the "Reporting Issues" section). The section must include the social preview image upload step for COMM-01. Content:

```markdown
## Release Checklist

The following steps are required after each new release tag is pushed and CI completes.

### Social preview image

GitHub does not provide an API for uploading a social preview image. This step must be performed manually in the GitHub web UI:

1. Go to the repository settings: https://github.com/d44b/pulltrace/settings
2. Scroll down to **Social preview** under the **General** section.
3. Click **Edit** and upload a PNG or JPEG image (recommended: 1280x640px).
4. Click **Save changes**.

This image is shown when the repository URL is shared on social media (Twitter/X, LinkedIn, Slack, etc.). Without it, GitHub shows a generic preview.
```

**REQUIREMENTS.md:**

Update the three requirement checkboxes in the `## v0.2 Requirements` section from `[ ]` to `[x]` for MAINT-01, MAINT-02, and COMM-01:
- `- [ ] **MAINT-01**:` → `- [x] **MAINT-01**:`
- `- [ ] **MAINT-02**:` → `- [x] **MAINT-02**:`
- `- [ ] **COMM-01**:` → `- [x] **COMM-01**:`

Also update the Traceability table rows for MAINT-01, MAINT-02, COMM-01 — change `Pending` to `Complete` in the Status column.

Update the footer line: `*Last updated: 2026-02-23 after v0.2 roadmap creation*` → `*Last updated: 2026-02-23 after Phase 5 completion*`
  </action>
  <verify>
    <automated>grep -c "Release Checklist" /Users/jmaciejewski/workspace/pulltrace/CONTRIBUTING.md && grep -c "\[x\] \*\*MAINT-01\*\*" /Users/jmaciejewski/workspace/pulltrace/.planning/REQUIREMENTS.md && grep -c "\[x\] \*\*MAINT-02\*\*" /Users/jmaciejewski/workspace/pulltrace/.planning/REQUIREMENTS.md && grep -c "\[x\] \*\*COMM-01\*\*" /Users/jmaciejewski/workspace/pulltrace/.planning/REQUIREMENTS.md && echo "PASS: all checks passed"</automated>
    <manual>Read CONTRIBUTING.md end section — confirm social preview steps reference the correct GitHub settings URL and the 1280x640 recommendation. Confirm REQUIREMENTS.md shows all three as [x] and Phase 5 rows in Traceability say Complete.</manual>
  </verify>
  <done>CONTRIBUTING.md has a Release Checklist section with social preview upload instructions; REQUIREMENTS.md marks MAINT-01, MAINT-02, COMM-01 as [x] complete with Traceability status updated</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -A3 "Generate Helm repo index" .github/workflows/ci.yml` — shows --merge flag
2. `grep "Fetch existing" .github/workflows/ci.yml` — shows new fetch step with || true
3. `grep "Release Checklist" CONTRIBUTING.md` — section present
4. `grep "social preview" CONTRIBUTING.md` — instructions present
5. `grep "\[x\]" .planning/REQUIREMENTS.md` — shows 3 completed requirements
6. No CODE_OF_CONDUCT reference exists in CONTRIBUTING.md (was removed in Phase 1)
</verification>

<success_criteria>
Phase 5 is complete when:
- ci.yml helm repo index uses --merge so v0.2.0 chart push will preserve the v0.1.0 entry in index.yaml
- CONTRIBUTING.md contains a Release Checklist section with the social preview manual upload procedure
- REQUIREMENTS.md marks MAINT-01, MAINT-02, and COMM-01 as complete ([x])
- No dead links to CODE_OF_CONDUCT.md exist anywhere in CONTRIBUTING.md
</success_criteria>

<output>
After completion, create `.planning/phases/05-housekeeping/05-01-SUMMARY.md`
</output>
