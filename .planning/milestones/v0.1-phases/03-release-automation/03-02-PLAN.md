---
phase: 03-release-automation
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - .github/workflows/ci.yml
autonomous: true
requirements:
  - REL-02

must_haves:
  truths:
    - "Pushing git tag v0.1.0 triggers CI to create a GitHub Release with a title, install commands, and a link to the CHANGELOG entry"
    - "The GitHub Release includes the Helm chart .tgz as a downloadable release asset"
    - "The GitHub Release does not appear before the Helm classic repo index is live (github-release needs helm-release)"
    - "The release job only fires on semver tags (not on branch pushes)"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "github-release job that creates GitHub Release via softprops/action-gh-release@v2 with inline body and chart .tgz asset"
      contains: "softprops/action-gh-release"
  key_links:
    - from: ".github/workflows/ci.yml github-release job"
      to: "helm-release job"
      via: "needs: [helm-release] — ensures release appears after Helm index is live; shares chart artifact via download-artifact"
      pattern: "needs: \\[helm-release\\]"
    - from: ".github/workflows/ci.yml github-release job"
      to: "GitHub Release page"
      via: "softprops/action-gh-release@v2 with contents: write (set in 03-01)"
      pattern: "softprops/action-gh-release@v2"
    - from: "github-release job body"
      to: "CHANGELOG.md"
      via: "inline link to https://github.com/d44b/pulltrace/blob/main/CHANGELOG.md"
      pattern: "CHANGELOG.md"
---

<objective>
Add the `github-release` job to `ci.yml` that creates a GitHub Release on every semver tag push, with an inline release body containing install commands and a CHANGELOG link, plus the Helm chart `.tgz` as a release asset downloaded from the artifact uploaded by the `helm-release` job.

Purpose: Completes the release automation pipeline. The `github-release` job runs after `helm-release` (via `needs:`) so the GitHub Release only appears once the classic Helm index is live. Sharing the chart artifact avoids re-packaging and the duplicate `sed -i` pitfall.

Output: A new `github-release` job in `ci.yml`. After a semver tag push, the GitHub Releases page shows a release titled `v0.1.0` with install commands, a CHANGELOG link, and a `pulltrace-0.1.0.tgz` asset attached.
</objective>

<execution_context>
@/Users/jmaciejewski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jmaciejewski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-release-automation/03-RESEARCH.md
@.planning/phases/03-release-automation/03-01-SUMMARY.md
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add github-release job to ci.yml using softprops/action-gh-release@v2</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Append a new `github-release` job to the end of the `jobs:` section in `.github/workflows/ci.yml`. Do NOT modify any existing job.

Add the following job after the closing of the `helm-release` job:

```yaml
  # ── GitHub Release ─────────────────────────────────────────────────────────
  github-release:
    name: GitHub Release
    needs: [helm-release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Download chart artifact
        uses: actions/download-artifact@v4
        with:
          name: helm-chart
          path: /tmp/charts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "v${{ steps.version.outputs.version }}"
          body: |
            ## Pulltrace v${{ steps.version.outputs.version }}

            Real-time Kubernetes image pull progress monitor.

            ### Install via Helm (classic repo)

            ```bash
            helm repo add pulltrace https://d44b.github.io/pulltrace/charts
            helm repo update
            helm install pulltrace pulltrace/pulltrace --version ${{ steps.version.outputs.version }}
            ```

            ### Install via Helm (OCI)

            ```bash
            helm install pulltrace oci://ghcr.io/d44b/charts/pulltrace --version ${{ steps.version.outputs.version }}
            ```

            ### What's New

            See [CHANGELOG.md](https://github.com/d44b/pulltrace/blob/main/CHANGELOG.md) for full details.
          files: /tmp/charts/pulltrace-${{ steps.version.outputs.version }}.tgz
          make_latest: "true"
```

Key decisions and their rationale:
- `needs: [helm-release]`: Ensures release appears only after `index.yaml` is live and the `.tgz` artifact is uploaded. Also inherits `contents: write` scope from the workflow-level permission set in 03-01.
- `actions/download-artifact@v4`: Downloads the chart artifact uploaded by helm-release, avoiding re-packaging and a second `sed -i`. The artifact name `helm-chart` must match exactly what was uploaded in 03-01.
- `softprops/action-gh-release@v2`: Project decision from STATE.md. No PAT required with `contents: write` at workflow level.
- `body:` inline (not `body_path:`): Avoids dumping the entire CHANGELOG header and `[Unreleased]` section into the release body. The inline body links to the CHANGELOG for full details.
- `make_latest: "true"`: Marks this release as the latest on the GitHub Releases page.
- No `concurrency` block on this job: It already serializes via `needs: [helm-release]`, which holds the `deploy-gh-pages` concurrency slot.

Do NOT use `body_path: CHANGELOG.md` — this would dump the full 23-line CHANGELOG verbatim into the release body including the `[Unreleased]` heading.
Do NOT add `draft: true` — the release should be published immediately.
Do NOT re-run `helm package` or `sed -i` in this job — the artifact from helm-release is the authoritative packaged chart.
  </action>
  <verify>
    <automated>cd /Users/jmaciejewski/workspace/pulltrace && grep -n "github-release\|softprops/action-gh-release\|download-artifact\|make_latest" .github/workflows/ci.yml && python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml')); print('ci.yml: valid YAML')"</automated>
    <manual>Confirm the github-release job appears after helm-release in ci.yml. Confirm `needs: [helm-release]` is present. Confirm `softprops/action-gh-release@v2` is the action version. Confirm `download-artifact@v4` with `name: helm-chart` matches the upload in helm-release. Confirm inline body references both helm repo add and OCI install paths.</manual>
  </verify>
  <done>
    - `github-release` job exists in ci.yml with `needs: [helm-release]`
    - `if: startsWith(github.ref, 'refs/tags/v')` guard is present
    - `actions/download-artifact@v4` downloads `helm-chart` artifact to `/tmp/charts`
    - `softprops/action-gh-release@v2` creates the release with inline body and `.tgz` file attachment
    - `make_latest: "true"` is set
    - ci.yml is valid YAML (no parse errors)
  </done>
</task>

</tasks>

<verification>
Run these checks after the task completes:

```bash
# 1. Confirm github-release job exists and has correct structure
grep -A 40 "github-release:" .github/workflows/ci.yml

# 2. Confirm job dependency ordering
grep -n "needs:" .github/workflows/ci.yml

# 3. Confirm tag guard is present
grep -n "startsWith.*refs/tags/v" .github/workflows/ci.yml

# 4. Confirm download-artifact name matches upload-artifact name from 03-01
grep -n "name: helm-chart" .github/workflows/ci.yml

# 5. Confirm ci.yml is valid YAML
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml')); print('ci.yml: valid YAML')"

# 6. Full job graph overview
grep -n "^\s\{2\}[a-z]" .github/workflows/ci.yml | grep -v "^.*#"
```
</verification>

<success_criteria>
- `github-release` job is present in `ci.yml`
- Job dependency: `needs: [helm-release]` (not `needs: [docker]` directly)
- Tag guard: `if: startsWith(github.ref, 'refs/tags/v')` present on the job
- Artifact download: `actions/download-artifact@v4` with `name: helm-chart` (matching helm-release upload)
- Release action: `softprops/action-gh-release@v2` with inline body, `.tgz` files attachment, `make_latest: "true"`
- `ci.yml` is valid YAML
- No re-packaging of the chart in this job (no helm package, no sed -i)
</success_criteria>

<output>
After completion, create `.planning/phases/03-release-automation/03-02-SUMMARY.md` summarizing:
- The github-release job structure and how it integrates with helm-release via needs + artifact sharing
- The inline release body content (what install commands it includes)
- Any deviation from the plan and why
- The full job execution sequence: lint-test/build-ui/helm-lint → docker → helm-release → github-release
</output>
